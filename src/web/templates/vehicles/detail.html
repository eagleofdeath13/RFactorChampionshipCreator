{% extends "base.html" %}

{% block title %}Détails du Véhicule - rFactor Championship Creator{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="/vehicles" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Retour à la liste
        </a>
    </div>
    <div class="col-12">
        <h1 class="mt-3 mb-3" id="vehicle-title">
            <i class="bi bi-car-front-fill"></i> Détails du véhicule
        </h1>
        <p class="text-muted mb-0"><small>Chemin/identifiant: <code id="vehicle-path">{{ vehicle_path }}</code></small></p>
    </div>
    <div class="col-12 mt-3">
        <div id="vehicle-alert" class="alert d-none" role="alert"></div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-3">
        <div class="card">
            <div class="card-header">
                Informations principales
            </div>
            <div class="card-body" id="vehicle-main">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                    <div>Chargement des informations du véhicule...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-3">
        <div class="card mb-3">
            <div class="card-header">Configuration</div>
            <div class="card-body" id="vehicle-config">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Équipe</div>
            <div class="card-body" id="vehicle-team">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadVehicleDetail() {
    const path = document.getElementById('vehicle-path').textContent.trim();
    try {
        LoadingOverlay.show('Chargement du véhicule...');
        const vehicle = await APIClient.get(`/api/vehicles/${encodeURIComponent(path)}`);

        // Titre
        document.getElementById('vehicle-title').innerHTML = `
            <i class="bi bi-car-front-fill"></i>
            ${vehicle.display_name || vehicle.file_name}
            <small class="text-muted">#${vehicle.number || ''}</small>
        `;

        // Bloc principal
        document.getElementById('vehicle-main').innerHTML = `
            <dl class="row mb-0">
                <dt class="col-sm-4">Pilote</dt>
                <dd class="col-sm-8">${vehicle.team_info?.driver ? `<a href="/talents/${encodeURIComponent(vehicle.team_info.driver)}" class="text-decoration-none">${vehicle.team_info.driver}</a>` : 'N/A'}</dd>

                <dt class="col-sm-4">Équipe</dt>
                <dd class="col-sm-8">${vehicle.team_info?.team || 'N/A'}</dd>

                <dt class="col-sm-4">Constructeur</dt>
                <dd class="col-sm-8">${vehicle.manufacturer || 'N/A'}</dd>

                <dt class="col-sm-4">Moteur</dt>
                <dd class="col-sm-8">${vehicle.engine || 'N/A'}</dd>

                <dt class="col-sm-4">Classes</dt>
                <dd class="col-sm-8"><span class="badge bg-info-subtle text-info-emphasis">${(vehicle.class_list||[]).join('</span> <span class=\"badge bg-info-subtle text-info-emphasis\">') || 'N/A'}</span></dd>

                <dt class="col-sm-4">Fichier</dt>
                <dd class="col-sm-8"><code>${vehicle.relative_path || vehicle.file_name}</code></dd>
            </dl>
        `;

        // Configuration
        const cfg = vehicle.config || {};
        document.getElementById('vehicle-config').innerHTML = `
            <ul class="list-unstyled mb-0">
                <li><strong>GenString:</strong> <code>${cfg.gen_string ?? 'N/A'}</code></li>
                <li><strong>HDV (référence):</strong> <code>${cfg.hdvehicle ?? 'N/A'}</code></li>
                <li><strong>HDV (résolu):</strong> ${cfg.hdvehicle_resolved ? `<code>${cfg.hdvehicle_resolved}</code>` : 'N/A'}</li>
                <li><strong>HDV (existe):</strong> ${cfg.hdvehicle_resolved ? (cfg.hdvehicle_exists ? '<span class="badge bg-success">Oui</span>' : '<span class="badge bg-danger">Non</span>') : 'N/A'}</li>
                <li><strong>Graphics:</strong> <code>${cfg.graphics ?? 'N/A'}</code></li>
                <li><strong>Spinner:</strong> <code>${cfg.spinner ?? 'N/A'}</code></li>
            </ul>
        `;

        // Équipe
        const team = vehicle.team_info || {};
        document.getElementById('vehicle-team').innerHTML = `
            <ul class="list-unstyled mb-0">
                <li><strong>Driver:</strong> ${team.driver ? `<a href="/talents/${encodeURIComponent(team.driver)}" class="text-decoration-none">${team.driver}</a>` : 'N/A'}</li>
                <li><strong>Team:</strong> ${team.team ?? 'N/A'}</li>
                <li><strong>Number:</strong> ${vehicle.number ?? 'N/A'}</li>
            </ul>
        `;

    } catch (e) {
        const alert = document.getElementById('vehicle-alert');
        alert.className = 'alert alert-danger';
        alert.textContent = 'Impossible de charger le véhicule: ' + (e.message || 'erreur inconnue');
        alert.classList.remove('d-none');
    } finally {
        LoadingOverlay.hide();
    }
}

document.addEventListener('DOMContentLoaded', loadVehicleDetail);
</script>
{% endblock %}
