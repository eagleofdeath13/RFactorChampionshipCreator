{% extends "base.html" %}

{% block title %}Détail du circuit - rFactor Championship Creator{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="/tracks" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Retour à la liste
        </a>
    </div>
    <div class="col-12">
        <h1 class="mt-3 mb-3" id="track-title">
            <i class="bi bi-flag"></i> Détails du circuit
        </h1>
        <p class="text-muted mb-0"><small>Chemin/identifiant: <code id="track-path">{{ track_path }}</code></small></p>
    </div>
    <div class="col-12 mt-3">
        <div id="track-alert" class="alert d-none" role="alert"></div>
    </div>
  </div>

<div class="row">
    <div class="col-lg-7 mb-3">
        <div class="card">
            <div class="card-header">Informations principales</div>
            <div class="card-body" id="track-main">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                    <div>Chargement du circuit...</div>
                </div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">Informations GDB</div>
            <div class="card-body" id="track-gdb">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-3">
        <div class="card">
            <div class="card-header">Fichier</div>
            <div class="card-body" id="track-file">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadTrackDetail() {
    const path = document.getElementById('track-path').textContent.trim();
    try {
        LoadingOverlay.show('Chargement du circuit...');
        const track = await APIClient.get(`/api/tracks/${encodeURIComponent(path)}`);

        document.getElementById('track-title').innerHTML = `
            <i class="bi bi-flag"></i>
            ${track.display_name || track.file_name}
        `;

        document.getElementById('track-main').innerHTML = `
            <dl class="row mb-0">
                <dt class="col-sm-4">Nom</dt>
                <dd class="col-sm-8">${track.track_name || 'N/A'}</dd>

                <dt class="col-sm-4">Lieu</dt>
                <dd class="col-sm-8">${track.venue_name || 'N/A'}</dd>

                <dt class="col-sm-4">Layout</dt>
                <dd class="col-sm-8">${track.layout || 'N/A'}</dd>
            </dl>
        `;

        document.getElementById('track-file').innerHTML = `
            <ul class="list-unstyled mb-0">
                <li><strong>Fichier:</strong> <code>${track.file_name}</code></li>
                <li><strong>Chemin relatif:</strong> <code>${track.relative_path}</code></li>
                <li><strong>Chemin complet:</strong> <code>${track.file_path}</code></li>
            </ul>
        `;

        // Render GDB info
        const gdbEl = document.getElementById('track-gdb');
        const info = track.gdb_info || {};
        const exclude = new Set(['TrackName', 'VenueName', 'Layout']);
        const entries = Object.entries(info)
            .filter(([k]) => !exclude.has(k))
            .sort((a,b) => a[0].localeCompare(b[0]));
        if (entries.length === 0) {
            gdbEl.innerHTML = '<div class="text-muted">Aucune information supplémentaire trouvée dans le GDB.</div>';
        } else {
            gdbEl.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead>
                            <tr><th>Clé</th><th>Valeur</th></tr>
                        </thead>
                        <tbody>
                            ${entries.map(([k,v]) => `
                                <tr>
                                    <td><code>${k}</code></td>
                                    <td>${v === '' ? '<span class="text-muted">(vide)</span>' : v}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    } catch (e) {
        const alert = document.getElementById('track-alert');
        alert.className = 'alert alert-danger';
        alert.textContent = 'Impossible de charger le circuit: ' + (e.message || 'erreur inconnue');
        alert.classList.remove('d-none');
    } finally {
        LoadingOverlay.hide();
    }
}

document.addEventListener('DOMContentLoaded', loadTrackDetail);
</script>
{% endblock %}
