{% extends "base.html" %}

{% block title %}Championnats - rFactor Championship Creator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-trophy-fill"></i> Gestion des Championnats
            </h1>
            <a href="/championships/create/new" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Créer un Championnat Custom
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Statut</th>
                        <th>Opposants</th>
                        <th>Points Joueur</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="championships-table-body">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadChampionships() {
    try {
        const championships = await APIClient.get('/api/championships/');
        renderChampionships(championships);
    } catch (error) {
        ToastNotification.error('Erreur lors du chargement des championnats');
        console.error(error);
    }
}

function renderChampionships(championships) {
    const tbody = document.getElementById('championships-table-body');
    // Note: Based on real .cch files analysis, SeasonStatus=2 means "in progress", not "completed"
    // The actual mapping appears to be: 0=not started, 1=unknown/unused, 2=in progress
    const statusLabels = ['Non démarré', 'Inconnu', 'En cours'];

    if (championships.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Aucun championnat trouvé</td></tr>';
        return;
    }

    tbody.innerHTML = championships.map(champ => `
        <tr onclick="window.location.href='/championships/${encodeURIComponent(champ.filename)}'">
            <td>${champ.name}</td>
            <td><span class="badge status-${champ.status}">${statusLabels[champ.status] || 'Inconnu'}</span></td>
            <td>${champ.opponents}</td>
            <td>${champ.player_points}</td>
            <td class="text-end">
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteChampionship('${champ.filename}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

async function deleteChampionship(filename) {
    if (!confirmDelete(filename, 'le championnat')) {
        return;
    }

    try {
        LoadingOverlay.show('Suppression...');
        await APIClient.delete(`/api/championships/${encodeURIComponent(filename)}`);
        ToastNotification.success(`Championnat "${filename}" supprimé`);
        await loadChampionships();
    } catch (error) {
        ToastNotification.error(`Erreur: ${error.message}`);
    } finally {
        LoadingOverlay.hide();
    }
}

document.addEventListener('DOMContentLoaded', loadChampionships);
</script>
{% endblock %}
